var commands={};
var needR={};
var sendStick;
var sendMess;
var sendPhoto;
var request=require('request');
function reader(r,id){
    this.r=r;
    this.id=id;
}
function addReader(r,id){
    //console.log(arguments);

    // console.log('Создан ридер');
    //sendMess(id,reader.msg);
    //needR.push(reader);
    if(!needR[id])
        needR[id]=[];
    needR[id].push(new reader(r,id));
}
function findR(id){
   // console.log(needR);
     for(var i in needR[id]){
        return needR[id][i];
     }
    return null;
}
function command(f,ms){
    this.f=f;
    this.diskr=ms;
}
function addCommand(name,f,ms){
    commands['/'+name]=new command(f,ms);
}
function AdAd(name){
    var ad=require('ADS/'+name);
    ad.getN(name);
    ad.getR(addReader);
    ad.getMess(sendMess);
    ad.getStick(sendStick);
    ad.getPhoto(sendPhoto);
    var inf=ad.info();
    if(!inf) inf='Нет описания';
    addCommand(name,ad.mainF,inf);

    var adF=ad.addF();
    for (var i in adF){
        addCommand(name+i,adF[i].f,adF[i].disc);
    }
}

//commands['/commands']=info;

function info(text,id){
    var res='';
    for(var i in commands){
        res+=i+' - '+commands[i].diskr+' \n';

    }
    sendMess (id,res);
}
f= function (chId,text,date,user,sender) {
    text=text.replace(/^\s*([\S\s]*?)\s*$/, '$1');
    var r=findR(chId);
    //console.log(needR);
    if(r){
        var res={};
        if(text!=='SSTOOP')
            res= r.r.f(text);
        res['del']=res['del']||true;
        if(res.del || text=='SSTOOP') {
            delete needR[chId][needR[chId].indexOf(r)];
        }
        return;
    }
    var command='';
    var w=text.split(' ');
    for(var i in commands){
        if(w[0]===i){
            command=i;
            break;
        }
    }
    if(command){
       text = text.substring(command.length + 1);
       commands[command].f(text,chId);
    }

};
exports.ans=f;
exports.getStick=function(s){
    sendStick=s;
};
exports.getMess=function(s){
   // console.log(s);
    sendMess=s;
   // console.log(sendMess);
};
exports.getPhoto=function(s){
    // console.log(s);
    sendPhoto=s;
    // console.log(sendMess);
};
exports.loadCom=function(){
    addCommand('commands',info,'Все команды');
    AdAd('TABLE');
    AdAd('ANSWER');
    AdAd('WIKIPEDIA');
    AdAd('TTT');
    AdAd('SKR');
    AdAd('freshMEM');
    AdAd('BALDA');
    AdAd('Solve');
    AdAd('Contacts');
   // console.log(commands);
};
//console.log(needR);